# README

我们使用 dddappp 这个低代码平台来开发这个游戏。虽然 dddappp 并不是专门为游戏开发设计的，但是它完全可以作为一个“全链游戏引擎”来使用。

使用 dddappp 开发全链游戏令人难以置信地简单。

我们只要先做好需求分析和领域建模，然后编写 DDDML 模型文件，再运行 dddappp 创建工具，生成大部分代码，然后在某些特定地方填充少量的业务逻辑的实现，就可以完成一个全链游戏的开发。

## 需求分析与领域建模

### Items

### Skills

Item（物品）有两种“生产/创造”方式：

* Item Production。需要“原材料”，生产时需要消耗一定数量的原材料（其他 Items，比如从CottonSeeds->Cottons）。
* Item Creation。不需要原材料。

同一种东西（Item），是可能可以通过不同的技能（Skill）获得的。比如你可以通过 “Farming” 技能种植、收获一种农产品，也可以“偷窃”技能获得它。

Skill（技能）要么是生产（Production）型的技能，要么是创造（Creation）型的技能，不会两者都是。比如：

* Farming（农业）是生产型的技能。需要消耗“种子”（原材料 items）。种子可以从市场购买、可以“偷窃”（偷窃是创造型的技能）或者使用其他技能获得。
* Mining（挖矿）和 Woodcutting（伐木）是创造型的技能。
  * 我们需要给玩家对这些创造型技能的使用做一些限制。
  * 严格来说，它不太像生产型技能那样，后者主要是通过设置“生产配方”所需的（可能是多种）原材料 item 和数量来达到对技能的使用限制。
  * 不过，仍然可以将“一种创造型技能的使用配额”抽象为一个特殊的 Item(Id) 和 quantity 的 pair。

### Skill Processes

实体 Skill Process（技能流程）表示执行 Item Production 或 Item Creation 的过程。

#### Item Production 的 Skill Process

执行 Skill Process 生产 Item，对于大多数 Item，生产成果只需要使用“Item ID 和数量”表示就可以了。

但是 Skill Process 还需要有一些用来制造“Item 的独特个体”的方法。

* 在 MVP 版本中，具有“独特个体”的 Item 主要指的是 Ship。所以，我们给 SkillProcess 定义了 StartShipProduction / CompleteShipProduction 方法。
* 方法 StartShipProduction 的参数列表应该包含表示“实际投入的材料数量”的信息，因为它们可以大于 Item Production 中规定的（最少）数量。

[TBD]

### 前后端待确认问题

#### 位置坐标的表示问题

后端建议：

* 合约（后端）的坐标值以 u32（无符号 32 位整数，其最大值为 `4,294,967,295`）表示，因为主流的智能合约语言（包括 Move）一般都没有“有符号整数”的类型。
* 前端如有必要，可以执行坐标变换，可以将合约中存储的 u32 整数坐标值换算为 i32 坐标值（有符号 32 位整数）。
  可以考虑将原始的 u32 坐标值减去 i32 位整数的最大值 `2,147,483,647` ， 得到负数或者正数表示的坐标值。
  即以 u32 坐标值表示的地图的中心点为 `("2,147,483,647", "2,147,483,647")`。
* 不建议在链上以补码的形式在 u32 类型的字段中存储（正 / 负）坐标值，因为这样会明显增加位置计算逻辑的复杂度。

#### 速度的单位转换问题

* 需要明确 Ship 的 speed 值和以 `“坐标单位 / 秒”`的速度值之间的转换关系。
  * 比如 Ship 的 speed 值是 `1`，那么表示它每分钟（60 秒）移动 100 个坐标单位。
* 后端合约中，时间点是以“秒”计量的 Unix 时间。即从 1970 年 1 月 1 日 0 时 0 分 0 秒开始的秒数。

#### 船队的当前位置问题

* 要更新“船队”在链上的位置状态，需要发送交易（消耗 Gas / 产生费用），所以船队的链上状态可能不适宜“实时”更新。
  那么，很多时候船队的“实时位置”可能需要链下计算。这里的链下包括前端（浏览器）链下服务（indexer）。
* 当船队处于航行状态，那么可能需要根据这些属性来计算船队的当前位置：
  * 最后一次更新的坐标；
  * 航行的目标位置坐标；
  * 船队的移动速度；
  * 最后一次更新坐标的时间。
* 链下计算“当前位置”可能会得出这样一个结果：船队已经到达目的地，实际上处于“停泊”状态。
* 当然，链上状态也不能总是不更新，在有机会发送“交易”上链的时候，触发合约的“船队状态更新逻辑”即可。
* 船队位置的链下计算逻辑需要和链上（合约）的计算逻辑保持一致。
  * 虽然最终状态是以“链上状态”为准，但是链下的计算逻辑如果出错可能会导致不好的用户体验。（即：按照链下计算结果，一笔交易所需要的前置条件已经满足，但是在提交到链上执行的时候发生失败。）
  * 链上合约的“当前位置”的计算逻辑见 [direct_route_util.move](./sui-contracts/infinite-sea-common/sources/utils/direct_route_util.move)。
  * 链上合约的船队位置状态的更新逻辑见 [roster_update_location_logic.move](./sui-contracts/infinite-sea/sources/roster_update_location_logic.move)。

#### 事件订阅机制的测试

在 Ship Battle 发生时，前端交互对于实时性的要求可能比较高。（不知每轮 10 秒的出招时间是否足够？）

* 链的状态达到终结性是需要一点时间的；特别是节点的部分查询接口，是依赖（它内部的）“索引服务”实现的，这些接口可能多少会有所延迟。
* 前端最好先做一些测试，通过订阅链上事件的方式，看看是不是可以获得足够快的实时性（不知 Sui TS SDK 是否封装了订阅事件的方法）。

## 编码

### 编写 DDDML 模型文件

模型文件位于目录 `./dddml` 下。

> **Tip**
>
> About DDDML, here is an introductory article: ["Introducing DDDML: The Key to Low-Code Development for Decentralized Applications"](https://github.com/wubuku/Dapp-LCDP-Demo/blob/main/IntroducingDDDML.md).

### 生成代码

```shell
docker run \
-v .:/myapp \
wubuku/dddappp:0.0.1 \
--dddmlDirectoryPath /myapp/dddml \
--boundedContextName Dddml.SuiInfiniteSea \
--suiMoveProjectDirectoryPath /myapp/sui-contracts \
--boundedContextSuiPackageName infinite_sea \
--boundedContextJavaPackageName org.dddml.suiinfinitesea \
--javaProjectsDirectoryPath /myapp/sui-java-service \
--javaProjectNamePrefix suiinfinitesea \
--pomGroupId dddml.suiinfinitesea \
--enableMultipleMoveProjects
```

### 实现业务逻辑

在生成代码后，我们需要填充一些业务逻辑的实现。

你可以看到，在我们这个代码库的源代码中，所有以 `// <autogenerated>` 开头的文件，都是由 dddappp 工具生成的，我们不应该修改它们。这些代码占了整个代码库的绝大部分。

其他需要我们填充业务逻辑的文件，dddappp 工具也帮我们生成了脚手架代码，也就是函数的签名部分，我们只需要填充其中的“函数体”（body）部分。

具体来说，我们主要是在以 `_logic.move` 结尾的文件中填充模型中定义的“实体的方法”的实现。

如果你在领域模型中定义了“领域服务”，那么，还需要在以 `_service.move` 结尾的文件中填充“领域服务”的实现。
一般来说，它们应该是很薄的一层“包装”代码，只是对领域模型中的实体的方法的组合调用，不会包含复杂的业务逻辑。

值得一提的是，链下服务（off-chain service，有时候会被称为 indexer）是 100% 自动生成的。
你甚至一行代码都不需要写，只需要配置一下发布合约的交易摘要，就可以直接使用了。

#### 程序中使用的常量

#### Item（物品、资源） ID 常量


| Item Id    | Name                    | 说明                                    |
| ---------- | ----------------------- | --------------------------------------- |
| 0          | UNUSED_ITEM             | 未使用                                  |
| 2          | CottonSeeds             | 棉花种子                                |
| 102        | Cotton                  | 棉花（由棉花种子种植得到）              |
| 200        | Normal Log              | 木头（砍伐之后成品)                     |
| 301        | CopperOre               | 铜（挖矿之后成品）                      |
| 1000000001 | Ship                    | 船（建造得到）                          |
| 2000000001 | ResourceTypeWoodcutting | 伐木资源(伐木Wooding之后得到 Normal Log |
| 2000000003 | ResourceTypeMining      | 挖矿资源(挖矿Mining之后得到 CooperOre   |

#### 技能常量


| 技能        | 常量 | 说明 |
| ----------- | ---- | ---- |
| farming     | 0    | 种植 |
| woodcutting | 1    | 伐木 |
| mining      | 3    | 挖矿 |
| crafing     | 6    | 造船 |

## 测试应用

### 发布合约

链上合约包括三个项目（包）：

1. Coin 合约项目
2. Common 合约项目
3. Main 合约项目

#### Testnet 发布信息

我们在 Sui testnet 上发布以上 3 个合约包，相关信息记录如下：

```json
{
  "coin": {
    "TreasuryCap": "0xb832e0d3c39dddab7181e08bb193e7b813770139b2401f29a3c683ee3d1296c7",
    "PackageId": "0xcf2c3b147d64badb2fbe9e8574004dd8a30b9dc417e0a26eaaddfcfbc0cbc532",
    "Digest": "FA5PHdEzLWZ8S6oXZ8DtHwd5yUEVD3fwLtSzszbhXuiE",
    "EnergyId": "0x30205ca82aeab727937149fa9456ab8553cb0494350ac158f20dfdd3de466403"
  },
  "common": {
    "Digest": "QnDYV5DtMK6C3wX8rWkQcoe9woRoGGmx2mAUkA1mbq2",
    "ItemTable": "0x33bb3e6b51a0ef9197ac577d67ccf4f31df3a5a098400e07e1de9bafe64d4039",
    "ExperienceTable": "0x48a5284bd638ddae564f268c910726b461e47dc1aac8f4b104e4373b5d5ea738",
    "ItemCreationTable": "0x775322c064f71e411cc1b24388627a2ebf8a7efa86005b795f0fcdc0e7afc841",
    "PackageId": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487",
    "Publisher": "0xe10e7b40567e52ad7fadf0e9e5e9dbd22e01aea6e571e78a180665058d610195",
    "ItemProductionTable": "0xe4976f4a8a5b3660afd00e3d507d858dfdbc3825005df34ec330d116a2925fc3",
    "ItemCreationMining": "0x6a5cb4777086f63569f03f186ce0cfcbd8d32e523cf39ee8b13140244da27ad3",
    "ItemProductionFarming": "0x7adeee1b2bc8fdff2d63d9ebf2746aa9ff25efacfc8c3451c7f8ba4e07094cd7",
    "ItemCreationWooding": "0xd8c1474f9a8e957f2c29e360f9ed037c3a92da9122a3c7b0e18d6fb45de40154",
    "ItemProductionCrafting": "0xe41a615e902dae33fc22671ba2d43462e2f89236ecef3e182fafa6f9f3dbda44"
  },
  "main": {
    "Digest": "9VfayLCVLp7hBPGLpQyoztgiuqLerAzhwqLELdpR9RQh",
    "PackageId": "0x8d4b0f3b3be41e525ec63e252f14b52e149ead9b2904f55a8b3878044999b56b",
    "Publisher": "0x90b70a3bbcd0b0d5d203e2d6cf77c65a3a0025b7671bab64d71c58a91d4b5b0f",
    "RosterTable": "0x920ce5e3b3afc1f6a312f59aec8b9e80b6ebe11c86f4ec5ae3f5cebc1ec34a7f",
    "AdminCap": "0x9b341caeae5a72ac6fc497fbd426b48565b2be69e7a73d90aadfb6a9b479f459",
    "UpgradeCap": "0xb0c8b32183ee7e40241a6969121a75e071426382f8279d7208d11ef691fa3d3e",
    "SkillProcessTable": "0xc90ce4d672d492d82ef1ec642b5ee2bd8756482f5372b8473ad7e5e063dfe209",
    "Map": "0xc9fa916b2613408af026091b17b505a3f49af001ff0c774516de5a1414716bd7",
    "Player": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291"
  }
}
```

解释如下：

* `coin.packageid`：Coin 合约包的 Id。
* `common.PackageId`：Common 合约包的 Id。
* `main.Digest`：发布 Main 包交易的摘要。
* `coin.EnergyId`：Mint 获得的能量币（`ENERGY`）的 Object ID。
* `main.Map`：地图（map）的 Object ID。
* `common.ExperienceTable` 玩家积分（经验）等级表的 Object ID。

特别注意 `common` 中的 `ItemCreationMining，ItemProductionFarming，ItemCreationWooding，ItemProducitonCrafting` 四个属性：

这些属性是合约发布之后，后台调用接口生成的关于生产制造的配方的 ID，前端可以将它们视为常量使用。


| 配方   | 调用占位符                 | 说明                                 |
| ------ | -------------------------- | ------------------------------------ |
| 挖矿   | {`ItemCreationMining`}     | 开始挖矿进程和结束挖矿进程时使用     |
| 伐木   | {`ItemCreationWooding`}    | 开始伐木进程和结束伐木进程时使用     |
| 种棉花 | {`ItemProductionFarming`}  | 开始种植棉花进程和结束棉花进程时使用 |
| 造船   | {`ItemProducitonCrafting`} | 开始造船进程和结束造船进程时使用     |

### 获取地图信息

使用以下 Sui CLI 命令可以取得地图对象的信息：

```shell
sui client object {main.map} --json
```

输出信息类似下面这样：

```JSON
{
  "objectId": "0xf36cfa34890b5f6845f538bdcb678e3822443c9b1f4f700db2a66a127d6d7162",
  "version": "37717652",
  "digest": "DwGg5Go9pTqb5fZXkmGzHKfUgDoTGDHZY8jYFRaGBQDW",
  "type": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::map::Map",
  "owner": {
    "Shared": {
      "initial_shared_version": 37712887
    }
  },
  "previousTransaction": "ErangDWTR3PgbEWDj8b7sy8Guao3No7c3ZFzt3zdioTM",
  "storageRebate": "1907600",
  "content": {
    "dataType": "moveObject",
    "type": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::map::Map",
    "hasPublicTransfer": false,
    "fields": {
      "admin_cap": "0xcc29ec9bf6e72e413f6f699a765f62c84ab028716fb4a2f1333bddb3d26c6cf1",
      "id": {
        "id": "0xf36cfa34890b5f6845f538bdcb678e3822443c9b1f4f700db2a66a127d6d7162"
      },
      "locations": {
        "type": "0x2::table::Table<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::coordinates::Coordinates, 0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::map_location::MapLocation>",
        "fields": {
          "id": {
            "id": "0xc64d10079ffcb61c167ad8793a585092939df129f7a284ee5fefebc57fc98dfe"
          },
          "size": "2"
        }
      },
      "schema_version": "0",
      "version": "3"
    }
  }
}
```

我们主要关注其中的 `content.locations`属性部分，该部分表示地图上目前已经添加的岛屿。

可以使用 curl 请求 Sui JSON RPC 接口：

```
curl -X POST -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"suix_getDynamicFields","params":[$content.locaions.fields.id.id]}' https://fullnode.testnet.sui.io/
```

可以获得以下类似信息：

```JSON
{
    "jsonrpc": "2.0",
    "result": {
        "data": [
            {
                "name": {
                    "type": "0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::coordinates::Coordinates",
                    "value": {
                        "x": 51,
                        "y": 51
                    }
                },
                "bcsName": "9XmJiC4mP1y",
                "type": "DynamicField",
                "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::map_location::MapLocation",
                "objectId": "0x5dfb8153dfd0aeea1e1558e0b3f991cac1d8ab5e797627ad4445ce4ce099a692",
                "version": 37717652,
                "digest": "9H5nvaRUXbyULStSPsjUdDn7DXQS1nNFmVqKmRVyoMPn"
            },
            {
                "name": {
                    "type": "0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::coordinates::Coordinates",
                    "value": {
                        "x": 50,
                        "y": 50
                    }
                },
                "bcsName": "9N4dhPDnnU7",
                "type": "DynamicField",
                "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::map_location::MapLocation",
                "objectId": "0x78573cac493248eaea380c6658b839ad44c7a4e0bd0728d91b51a878edd3b16b",
                "version": 37716508,
                "digest": "BCn7aPsiJ2m935TZKXSbwozAt9U2MBzCrVtw1TVGbmJG"
            }
        ],
        "nextCursor": "0x78573cac493248eaea380c6658b839ad44c7a4e0bd0728d91b51a878edd3b16b",
        "hasNextPage": false
    },
    "id": 1
}
```

在上面的输出的例子中，地图上中存在两个岛屿，它们的坐标分别是 `(51, 51)` 和 `(50, 50)`。
对象类型为：`{main.packageId}::map_location::MapLocation`，对象 ID 分别为
`0x5dfb8153dfd0aeea1e1558e0b3f991cac1d8ab5e797627ad4445ce4ce099a692` 和 `0x78573cac493248eaea380c6658b839ad44c7a4e0bd0728d91b51a878edd3b16b`。

可以在控制台执行 Sui CLI 命令：

```
sui client object {mapLocationId} --json
```

可以得到类似以下的输出信息：

```json
"objectId": "0x5dfb8153dfd0aeea1e1558e0b3f991cac1d8ab5e797627ad4445ce4ce099a692",
  "version": "37717652",
  "digest": "9H5nvaRUXbyULStSPsjUdDn7DXQS1nNFmVqKmRVyoMPn",
  "type": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::coordinates::Coordinates, 0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::map_location::MapLocation>",
  "owner": {
    "ObjectOwner": "0xc64d10079ffcb61c167ad8793a585092939df129f7a284ee5fefebc57fc98dfe"
  },
  "previousTransaction": "ErangDWTR3PgbEWDj8b7sy8Guao3No7c3ZFzt3zdioTM",
  "storageRebate": "2812000",
  "content": {
    "dataType": "moveObject",
    "type": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::coordinates::Coordinates, 0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::map_location::MapLocation>",
    "hasPublicTransfer": false,
    "fields": {
      "id": {
        "id": "0x5dfb8153dfd0aeea1e1558e0b3f991cac1d8ab5e797627ad4445ce4ce099a692"
      },
      "name": {
        "type": "0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::coordinates::Coordinates",
        "fields": {
          "x": 51,
          "y": 51
        }
      },
      "value": {
        "type": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::map_location::MapLocation",
        "fields": {
          "coordinates": {
            "type": "0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::coordinates::Coordinates",
            "fields": {
              "x": 51,
              "y": 51
            }
          },
          "gathered_at": "0",
          "occupied_by": null,
          "resources": [
            {
              "type": "0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::item_id_quantity_pair::ItemIdQuantityPair",
              "fields": {
                "item_id": 2,
                "quantity": 200
              }
            },
            {
              "type": "0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::item_id_quantity_pair::ItemIdQuantityPair",
              "fields": {
                "item_id": 2000000001,
                "quantity": 200
              }
            },
            {
              "type": "0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::item_id_quantity_pair::ItemIdQuantityPair",
              "fields": {
                "item_id": 2000000003,
                "quantity": 200
              }
            }
          ],
          "type": 0
        }
      }
    }
  }
}
```

注意 `content.value.fields` 属性。 其中 `fileds` 包含位置坐标，
`gathered_at` 表示上一次收集资源的时间，
`occupied_by`表示此岛屿目前被谁（哪个玩家）占领，
如果没有被占领则为 `null` 或不存在相应的键值对，否则为玩家 ID（Player ID），
`resouces` 为该岛屿目前所拥有的资源列表。

`resources` 中包含 `fields` 属性，其中 `item_id` 为资源 ID，
其中，`item_id` 为 2 时表示“棉花种子”（前端可以定义一个常量列表）,
`quantity` 为该资源的数量。

上面一系列的查询操作，均是在通过 Sui JSON RPC 接口读取链上的数据完成（可能比较繁琐）。

#### 使用链下查询服务（indexer）获取地图信息

我们的低代码工具生成的链下 Java 服务（indexer）包含了很多开箱即用的查询接口。
其中，包含根据 Map 的对象 Id 查询 Map 信息的接口。
可使用 curl 命令发动测试请求，如下：

```curl
curl -X GET "http://{domain.port}/api/Maps/{main.map}" -H "accept: application/json"
```

返回的地图信息类似：

```json
{
  "id": "0xf36cfa34890b5f6845f538bdcb678e3822443c9b1f4f700db2a66a127d6d7162",
  "version": 4,
  "offChainVersion": 1,
  "locations": [
    {
      "coordinates": {
        "x": 50,
        "y": 50
      },
      "type": 0,
      "occupiedBy": "0x05c6464186392942be5949947b2830a17343ce66b5bae374d3345c5a05eb1b16",
      "gatheredAt": 1716178988,
      "offChainVersion": 4,
      "mapId": "0xf36cfa34890b5f6845f538bdcb678e3822443c9b1f4f700db2a66a127d6d7162"
    },
    {
      "coordinates": {
        "x": 60,
        "y": 60
      },
      "type": 0,
      "gatheredAt": 0,
      "offChainVersion": 0,
      "mapId": "0xf36cfa34890b5f6845f538bdcb678e3822443c9b1f4f700db2a66a127d6d7162",
      "resources": [
        {
          "itemId": 2,
          "quantity": 200
        },
        {
          "itemId": 2000000003,
          "quantity": 200
        },
        {
          "itemId": 2000000001,
          "quantity": 200
        }
      ]
    }
  ]
}
```

注意 `locations`属性，该属性为数组，每一个元素均代表一个位置点（目前地图上的位置点只有岛屿）。
元素中如果包含 `occupiedBy` 属性，表示该岛屿已经被玩家占有，其值为 Player ID。
`gatheredAt` 表示该岛屿的上次资源收集时间。
`resources` 属性包含该岛屿可以被收集的资源的 Item ID 和数量（岛屿可采集的“资源”我们也抽象为 Item，即“物品”）。

如果返回的岛屿元素中不包含 `resources` 属性。这通常表示该岛屿的资源已经被玩家收集过，还没有“再生的待收集资源”。

### 创建玩家对象

使用 Sui CLI 创建玩家（Player)：

```
sui client call --package {main.PackageId} --module player_aggregate --function create --args {playerName} --gas-budget 11000000 --json
```

解释：

* 其中 `{playName}` 为玩家名称。

如果成功，得到 JSON 响应大致如下（这里只展示玩家对象的创建信息）：

```json
{
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 37846616
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::player::Player",
      "objectId": "0x08bd581011fb1018d1f8d4cac006d05f7008a16d3f3a47f867fcc679d33a74a5",
      "version": "37846616",
      "digest": "5XNGiL6DMYNoVnaXZ5yoGmE2iEkJjXbhT7EQajEGJXe9"
    }
```

其中 `objectId` 即为新创建的玩家对象的 ID。
在后面的测试中，需要用到玩家对象 ID 的地方，我们使用占位符 `{playerId}` 来表示。

### 查询玩家信息

可以使用 curl 命令查询指定钱包地址所拥有的玩家对象：

```powershell
curl -X GET "http://{domin:port}/api/Players?owner={owner}" -H "accept: application/json"
```

其中 `{owner}` 为指定钱包地址。

可以获得如下格式的输出：

```json
[
    {
        "id": "0x05c6464186392942be5949947b2830a17343ce66b5bae374d3345c5a05eb1b16",
        "owner": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
        "level": 2,
        "experience": 105,
        "name": "John",
        "claimedIsland": {
            "x": 50,
            "y": 50
        },
        "version": 1,
        "offChainVersion": 1,
        "inventory": [
            {
                "itemId": 2000000001,
                "quantity": 199
            },
            {
                "itemId": 102,
                "quantity": 105
            },
            {
                "itemId": 2000000003,
                "quantity": 199
            }
        ]
    }
]
```

返回数据为 JSON 数组，如果数组为空，表示该钱包未拥有任何玩家，需要先创建一个玩家。
如果该数组不为空，表示该钱包地址下拥有的玩家对象（前端开发时需要尽量避免为一个钱包地址创建多个玩家对象，这样会增加开发的复杂性），
数组的元素的各属性解释如下：

* `id`：玩家对象的 ID。
* `owner`：玩家对象所属的钱包地址。
* `level`：玩家等级。
* `experience`：积分（“经验值”，这个名称从原型阶段就开始使用了，暂不作修改）。
* `name`：玩家的名字。
* `claimedIsland`：玩家所占领的岛屿的坐标。
* `inventory`：玩家目前拥有的物品（包括“资源”）库存，其中数组元素的 `item_id` 属性为物品（资源）的 ID，`quantity` 为库存数量。
  库存在进行生产活动时（种植，挖矿，伐木，造船等）时会减少或增加（原材料 item 数量会减少，产出结果 item 数量会增加）。

### 占领（Claim）岛屿

用户在创建玩家（Player）对象之后，可以对无人占领的岛屿进行占领（Claim）。

使用 Sui CLI 执行占领：

```shell
sui client call --package {main.PackageId} \
--module player_aggregate \
--function claim_island \
--args {playerId} \
{main.Map} \
{coordinates_x} \
{coordinates_y} \
{clock} \
{main.RosterTable} \
{main.SkillProcessTable} 
--gas-budget 4999000000 --json
```

解释：

* `{main.PackageId}`：Main 合约包的 ID。
* `{playerId}`：玩家对象 ID。
* `{main.map}`：地图对象的 ID。在 Main 合约包发布的时候，自动执行的初始化函数会创建地图对象。
* `{coordinates_x}`：Claim 的岛屿的 X 坐标值。
* `{coordinates_y}`：Claim 的岛屿的 Y 坐标值。
* `{clock}`：时钟对象的 ID。Sui 的时间对象 ID 是个固定值：`0x6`。
* `{main.RosterTable}`: Main 合约发布时初始化的一个 Table 对象的 ID。该 Table 中包含了包含所有的船队的“索引信息”。包含“玩家”以及“环境”船队。该 Table 的 Key 是“玩家 ID + 船队序号 `[0-4]`”的组合。
* `{main.SkillProcessTable}` Main 合约发布时初始化的一个 Table 对象的 ID。该 Table 包含所有技能流程（可以理解使用技能的“生产线”）的“索引信息”。
  这里的技能包括 Farming、WoodCutting、Mining、 Crafting。该 Table 的 Key 为“玩家 ID + SkillTypeId”的组合。

执行成功后返回内容节选重要部分如下：

```json
{
  "digest": "B46Tg4tuvrazHvqnkH29V5Haie9RHYqKLyHs9aciFJqG",
  "objectChanges": [
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::roster::Roster",
      "objectId": "0x02d20edd0c5766b4919e7ba07a1f746b32a6c80b3db9efa11788ea16810fb089",
      "version": "38211112",
      "digest": "GXZs2Zs8122DyNzHMPPGatRBaFScKezt8rHGi8SNqBdt"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xc36ee5a398f9848b35c0a6d62bb37ab10ecc68256d0fd44d5bea5f57a41e98d4"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::roster_id::RosterId, 0x2::object::ID>",
      "objectId": "0x04c1fb0e3af31cbe59f965e541ffe65e040ed302929531548f39da27df5821d0",
      "version": "38211112",
      "digest": "CuLGgN7HJFpiNh7nfVTuzjN4KEbHCZKqgEwRGeQ179jt"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xc36ee5a398f9848b35c0a6d62bb37ab10ecc68256d0fd44d5bea5f57a41e98d4"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::roster_id::RosterId, 0x2::object::ID>",
      "objectId": "0x09b967f3212fc396f855847d76bf06cdf41e6f6948c7a62729f01cce69c1f47e",
      "version": "38211112",
      "digest": "FtEXZQtV2MYAC4YTe3BoAjfVUxqV3LynvPjjdJVTKyt"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xc36ee5a398f9848b35c0a6d62bb37ab10ecc68256d0fd44d5bea5f57a41e98d4"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::roster_id::RosterId, 0x2::object::ID>",
      "objectId": "0x1859a93305fb450b9f788aa57cf1ae0c340266e57dad249da13e079a6c58a4aa",
      "version": "38211112",
      "digest": "H81ZQr4cT7D7z5HBpS2fBKgRMSCnXyjaQvNxSpcnJok4"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xb24e3d045a031d342c8dced3950f015684c21f2da5d77a012004e10864a23bd7"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::skill_process_id::SkillProcessId, 0x2::object::ID>",
      "objectId": "0x197ce1ce90645064b35132163f2355b2ca44d10e3694d1cf3890fa78e35001a1",
      "version": "38211112",
      "digest": "3unfu1sDB6Y3WmtFGBTLm1uS2bbVw5Kd3sft4T8dpTSz"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xb24e3d045a031d342c8dced3950f015684c21f2da5d77a012004e10864a23bd7"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::skill_process_id::SkillProcessId, 0x2::object::ID>",
      "objectId": "0x1d70b9d3f5b4b6bed1b43da07efd18355b1e12cbdfbe84bca18dbc85b15f44c6",
      "version": "38211112",
      "digest": "CxmMZqrQKT6sDVEM8AjfA3VPezQKpB4idM6KZFtsskDy"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::roster::Roster",
      "objectId": "0x244b6ed71ee283fd92c2004889a04462415227fb73e7aab7cf8cd99967de2541",
      "version": "38211112",
      "digest": "DD2ALt8yxHRmyhMNZ8oYJjFTc8LMCCxK8tDM2DJwxEG2"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::roster::Roster",
      "objectId": "0x3e69224c0b59c663f7a918efdeb2afb011b5dbddecc49f3bf4b4c0b4ba498a16",
      "version": "38211112",
      "digest": "BiMdYs6yKUBP7HpR91xeCRNg5XbiV5soGXtGvFrBRUcK"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xb24e3d045a031d342c8dced3950f015684c21f2da5d77a012004e10864a23bd7"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::skill_process_id::SkillProcessId, 0x2::object::ID>",
      "objectId": "0x46d1d9d3f3f818124f0b34870ca3f0c0c8631160829e317949b417afaeecb5c6",
      "version": "38211112",
      "digest": "D9RnLQxsumHt2JCZDFERJBptX9HHvK5Lb83eN2PFBAbw"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::skill_process::SkillProcess",
      "objectId": "0x4f902c9fc5b792792e757a791182e5bbe2c12684d02796d01e34758709670c97",
      "version": "38211112",
      "digest": "BJqA8Z3TFTc3RLvgoRbdVq8ymtW7AF6HPNS2LdqTRXs2"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xb24e3d045a031d342c8dced3950f015684c21f2da5d77a012004e10864a23bd7"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::skill_process_id::SkillProcessId, 0x2::object::ID>",
      "objectId": "0x65d7fe5a48eaf4ab32780db1e1bf286689095f7b28428cbfe20e6ad669a18dfb",
      "version": "38211112",
      "digest": "FuFv6KNUsmD8RbRKCZ6grUJcqcTEdKLkazgpjgh2vCHh"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::roster::Roster",
      "objectId": "0x7fa10794b24d2c2abda8626cfd894700dc2fe504cbbfa80bb4f37862aebdf562",
      "version": "38211112",
      "digest": "EFNwseqmecrtiq6b2eTtgR4BQJTuy26Xk2v4g2uJUWLw"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xc36ee5a398f9848b35c0a6d62bb37ab10ecc68256d0fd44d5bea5f57a41e98d4"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::roster_id::RosterId, 0x2::object::ID>",
      "objectId": "0x8459e00114dcdc965dacbf9bff002827c771a75c97f0f8636219ac07ce1ee7cf",
      "version": "38211112",
      "digest": "DosuYbLzGqsKrBbp56MkbsiriXDMNsrXASghpoPCZA2k"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::roster::Roster",
      "objectId": "0x8efcc4aa7c04df85a042fb537a041068211374c67204b5f29a58ead0693a302a",
      "version": "38211112",
      "digest": "rqsBuu7qMXQPBTnmnetmZSaaa5NobucCfBMaXV3u3bL"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xb24e3d045a031d342c8dced3950f015684c21f2da5d77a012004e10864a23bd7"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::skill_process_id::SkillProcessId, 0x2::object::ID>",
      "objectId": "0x9b7b21e42e48b254720c40cbf96d78fde0e90fcf41fa44d9f575e2dd418a33e5",
      "version": "38211112",
      "digest": "H4XcSjApqTj6i1PsfyJwExs7a3AwP2y9BJQ6JSJC833D"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "ObjectOwner": "0xc36ee5a398f9848b35c0a6d62bb37ab10ecc68256d0fd44d5bea5f57a41e98d4"
      },
      "objectType": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::roster_id::RosterId, 0x2::object::ID>",
      "objectId": "0x9ceea46de035cb467288325a1d51a782cedb53dae9e9a48f82c700c1d3489ce0",
      "version": "38211112",
      "digest": "C3ErjMt9PWt3oneiAxLyWT4kMJeZeZuTiEwQ6KusRzuZ"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::skill_process::SkillProcess",
      "objectId": "0xad00bf5bec692c71f9b765471cbca3149519b29e0436a89753006e99a1f0ca5f",
      "version": "38211112",
      "digest": "GTjHuUVGZwYrz1GCjQQL7Ztbma4zmL3TsW41ST6q7JpG"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::skill_process::SkillProcess",
      "objectId": "0xb67c787d2eafb523e0aee3bfaf2f42174cd9e088df7958c1b09cfd276b6578b3",
      "version": "38211112",
      "digest": "3jK4itwTA9gQU5YFEY2XA5xkge2CyDR9BmmcNujZ7oXu"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::skill_process::SkillProcess",
      "objectId": "0xc9acdba2a7b06e103064ba566643d0074dd689ceee03a306707e5e4345b476a8",
      "version": "38211112",
      "digest": "HndKvSZrgS42JSRib6PxDVib4XDB9oH8LzQqVwFDDnmC"
    },
    {
      "type": "created",
      "sender": "0x8f50309b7d779c29e1eab23889b9553e8874d2b9e106b944ec06f925c0ca4450",
      "owner": {
        "Shared": {
          "initial_shared_version": 38211112
        }
      },
      "objectType": "0x1f1267f7197c3f118b5d1f147a9ceb9296318f786842ab743715f0645fda30dc::skill_process::SkillProcess",
      "objectId": "0xd8831b89fd4157aaf58b60eef3a7f437c429373a35d18177ae1660baffee2f95",
      "version": "38211112",
      "digest": "7HhHHHddK6h3LxEpz6Tn5Sg1gWgtDHXdvq5jHNvTZ7QC"
    }
  ]
}
```

其中：

* 类型为 `{main.PackageId}::roster::Roster` 的元素，为玩家的船队信息。目前玩家在占领岛屿时，合约会创建 5 个船队对象。元素中的 `objectId` 属性为船队的对象 Id。
* 类型为 `0x2::dynamic_field::Field<{common.PackageId}::roster_id::RosterId, 0x2::object::ID>` 对象，
  是一个“保存船队信息的 Table”的“动态字段”子对象。
  通过这个对象，可以查询到船队的 ID 信息（参考下文关于如何查询 Move Table 的内容的介绍）。我们下面将船队的对象 ID 使用占位符 `{RosterObjectId}` 表示。
* 类型为 `{main.PackageId}::skill_process::SkillProcess` 的元素，该元素为玩家的“技能进程”对象。目前占领岛屿时，会创建 5 个这样的对象。
* 类型为 `0x2::dynamic_field::Field<{common.PackageId}::skill_process_id::SkillProcessId, 0x2::object::ID>` 的对象，是一个“保存技能进程信息的 Table”的“动态字段”子对象。
  这个对象的 ID 我们使用占位符 `{SkillProcess_dynamic_field_ObjectId}` 表示。
  通过这个对象，可以查询到技能进程的 ID 信息（参考下文关于如何查询 Move Table 的内容的介绍）。
  我们下面将技能进程的对象 ID 使用占位符 `{SkillProcessObjectId}` 表示。

#### 查询玩家的船队

使用 Sui CLI 命令可以取得某一个船队的信息：

```shell
sui client object {RosterObjectId} --json
```

输出信息类似下面这样：

```json
{
  "objectId": "0x8b1fe8c0bae52a1eccd9dcd0d3b5dbc081549950e6b3326ff6fd9c75bb09861b",
  "version": "38222489",
  "digest": "FvUvdSzCyqmP19QxmzsoxvzAuKeSFmPEoHGMv6sDUDcZ",
  "type": "0x8d4b0f3b3be41e525ec63e252f14b52e149ead9b2904f55a8b3878044999b56b::roster::Roster",
  "owner": {
    "Shared": {
      "initial_shared_version": 38222489
    }
  },
  "previousTransaction": "D1xCRt3k13KSmpDQGpL8GJcEh2pUf9erMzCm1vURjfco",
  "storageRebate": "2462400",
  "content": {
    "dataType": "moveObject",
    "type": "0x8d4b0f3b3be41e525ec63e252f14b52e149ead9b2904f55a8b3878044999b56b::roster::Roster",
    "hasPublicTransfer": false,
    "fields": {
      "admin_cap": "0x5ca182644b2013ed1fbdcc7af8ea5f75a17244af587d10ea6a442666f3dbeb69",
      "base_experience": null,
      "coordinates_updated_at": "0",
      "energy_vault": "0",
      "environment_owned": false,
      "id": {
        "id": "0x8b1fe8c0bae52a1eccd9dcd0d3b5dbc081549950e6b3326ff6fd9c75bb09861b"
      },
      "roster_id": {
        "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::roster_id::RosterId",
        "fields": {
          "player_id": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
          "sequence_number": 1
        }
      },
      "schema_version": "0",
      "ship_battle_id": null,
      "ship_ids": [],
      "ships": {
        "type": "0x2::object_table::ObjectTable<0x2::object::ID, 0x8d4b0f3b3be41e525ec63e252f14b52e149ead9b2904f55a8b3878044999b56b::ship::Ship>",
        "fields": {
          "id": {
            "id": "0x05967ae35658e974c23dd2e6d64b3831ce03e1e8740b7635c61323fdc8cd89c2"
          },
          "size": "0"
        }
      },
      "speed": 0,
      "status": 0,
      "target_coordinates": null,
      "updated_coordinates": {
        "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::coordinates::Coordinates",
        "fields": {
          "x": 50,
          "y": 50
        }
      },
      "version": "0"
    }
  }
}
```

注意其中的 `content.fields.roster_id` 属性。
可以看到其 `type` 为 `{common.PackageId}::roster_id::RosterId`，
其中的 `fields` 属性包括 `player_id` 和 `sequence_number`；
`player_id` 为玩家的 ID，`sequence_number` 为船队编号。

每个玩家有 5 个船队，编号依次为 0，1，2，3，4。
其中 0 号船队有特殊含义，表示 “Unassigned Ships”。
当玩家造船进程执行成功，得到的船只会默认被加入到该船队。

上面的查询结果中，新创建的船队对象中不包含船只信息。
当玩家将船只移入该船队后，将呈现更多的属性。

#### 查询玩家技能进程

可以将玩家的技能进程理解为制造物品（Item）的“生产线”。
玩家在占领一个岛屿之后，目前合约会为之自动创建 4 类 5 条这样的“生产线”。


| 类型                 | 对应技能类型常量值 | “生产线”数量 | 示例命令使用的“占位符”                           |
| -------------------- | ------------------ | -------------- | -------------------------------------------------- |
| 种植(Farming)        | 0                  | 2              | `{SkillProcessFarming1}`, `{SkillProcessFarming2}` |
| 伐木(WoodCuttinging) | 1                  | 1              | `{SkillProcessWooding}`                            |
| 挖矿(Mining)         | 3                  | 1              | `{SkillProcessMining}`                             |
| 造船(Crafting)       | 6                  | 1              | `{SkillProcessCrafting}`                           |

执行 Sui CLI 命令：

```shell
sui client object {SkillProcess_dynamic_field_ObjectId} --json
```

得到下面类似的输出信息：

```json
{
  "objectId": "0x197ce1ce90645064b35132163f2355b2ca44d10e3694d1cf3890fa78e35001a1",
  "version": "38211112",
  "digest": "3unfu1sDB6Y3WmtFGBTLm1uS2bbVw5Kd3sft4T8dpTSz",
  "type": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::skill_process_id::SkillProcessId, 0x2::object::ID>",
  "owner": {
    "ObjectOwner": "0xb24e3d045a031d342c8dced3950f015684c21f2da5d77a012004e10864a23bd7"
  },
  "previousTransaction": "B46Tg4tuvrazHvqnkH29V5Haie9RHYqKLyHs9aciFJqG",
  "storageRebate": "2667600",
  "content": {
    "dataType": "moveObject",
    "type": "0x2::dynamic_field::Field<0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::skill_process_id::SkillProcessId, 0x2::object::ID>",
    "hasPublicTransfer": false,
    "fields": {
      "id": {
        "id": "0x197ce1ce90645064b35132163f2355b2ca44d10e3694d1cf3890fa78e35001a1"
      },
      "name": {
        "type": "0x2b853e8306950ffdabe20df1ae5703c27dfb909d53099558113251f8a0d0a596::skill_process_id::SkillProcessId",
        "fields": {
          "player_id": "0xc68695161ec629a13e5e749f08207436aa6b47ce1b66c1f0ff63f77d1cce7228",
          "sequence_number": 0,
          "skill_type": 0
        }
      },
      "value": "0xb67c787d2eafb523e0aee3bfaf2f42174cd9e088df7958c1b09cfd276b6578b3"
    }
  }
}
```

注意 `content.fields.name.fields` 的三个属性：

* `player_id`：玩家 ID。
* `skill_type`：技能类型。
* `sequence_number`：“生产线”的编号。

依次查询前一步得到的 5 个 `{SkillProcess_dynamic_field_ObjectId}`，可以获取上面提及的 4 类 5 条“生产线”的 ID 信息。

上述 `skil_type`，`sequence_number` 以及 `content.fields.name.value` 与前文中的技能进程占位符之间存在以下对应关系：


| skill_type | sequence_number | content.fields.name.value |
| ---------- | --------------- | ------------------------- |
| 0          | 0               | `{SkillProcessFarming1}`  |
| 0          | 1               | `{SkillProcessFarming2}`  |
| 1          | 0               | `{SkillProcessWooding}`   |
| 3          | 0               | `{SkillProcessMining}`    |
| 6          | 0               | `{SkillProcessCrafting}`  |

通过 Sui JSON RPC 查询玩家的船队信息或技能进程信息，过程略显繁琐。
我们的链下查询服务（indexer）提供了更便捷的接口。

#### 通过 indexer 查询玩家的船队

使用 curl 命令获取指定玩家的船队信息：

```shell
curl -X GET "http://yangjiefeng.natapp1.cc:80/api/Rosters?rosterId.playerId={playerId}" \
-H "accept: application/json"
```

输出信息类似下面这样：

```json
[
    {
        "rosterId": {
            "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
            "sequenceNumber": 0
        },
        "id_": "0x4d92b147c3f3d11dda09709e21a9362735bc0e773bb39b0d161f5ecd9f2a3bff",
        "status": 0,
        "speed": 4,
        "ships": {
            "id": "0xde8410c83dd8827bbd039f41cccdb40be523db31546f29ab065a0944e8a274a0",
            "size": 1
        },
        "updatedCoordinates": {
            "x": 50,
            "y": 50
        },
        "coordinatesUpdatedAt": 0,
        "environmentOwned": false,
        "energyVault": 0,
        "version": 9,
        "offChainVersion": 9,
        "rosterShipsItems": [
            {
                "key": "0x17f835a304db4c0cc106e35f194d4f8c658a2ede0f00ca9f01b7878c7d5586cd",
                "value": {
                    "owner": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "building_expenses": {
                        "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pairs::ItemIdQuantityPairs",
                        "fields": {
                            "items": [
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 102,
                                        "quantity": 4
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 200,
                                        "quantity": 4
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 301,
                                        "quantity": 7
                                    }
                                }
                            ]
                        }
                    },
                    "attack": 5,
                    "protection": 4,
                    "id": {
                        "id": "0x17f835a304db4c0cc106e35f194d4f8c658a2ede0f00ca9f01b7878c7d5586cd"
                    },
                    "health_points": 20,
                    "version": "0",
                    "speed": 4
                },
                "offChainVersion": 0,
                "rosterId": {
                    "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "sequenceNumber": 0
                }
            }
        ],
        "shipIds": [
            "0x17f835a304db4c0cc106e35f194d4f8c658a2ede0f00ca9f01b7878c7d5586cd"
        ]
    },
    {
        "rosterId": {
            "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
            "sequenceNumber": 1
        },
        "id_": "0x8b1fe8c0bae52a1eccd9dcd0d3b5dbc081549950e6b3326ff6fd9c75bb09861b",
        "status": 0,
        "speed": 0,
        "ships": {
            "id": "0x05967ae35658e974c23dd2e6d64b3831ce03e1e8740b7635c61323fdc8cd89c2",
            "size": 0
        },
        "updatedCoordinates": {
            "x": 50,
            "y": 50
        },
        "coordinatesUpdatedAt": 0,
        "environmentOwned": false,
        "energyVault": 0,
        "version": 0,
        "offChainVersion": 0
    },
    {
        "rosterId": {
            "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
            "sequenceNumber": 2
        },
        "id_": "0x1a66c3613c83e7e88c3e9ee111306f8327a5b6f9ec6f1361b07588c26fcaca65",
        "status": 0,
        "speed": 0,
        "ships": {
            "id": "0xee0f09701ce72eafe2c4943a6a0edf65ac6cc8b00d805cee1ddffa55a5959533",
            "size": 0
        },
        "updatedCoordinates": {
            "x": 50,
            "y": 50
        },
        "coordinatesUpdatedAt": 0,
        "environmentOwned": false,
        "energyVault": 0,
        "version": 0,
        "offChainVersion": 0
    },
    {
        "rosterId": {
            "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
            "sequenceNumber": 3
        },
        "id_": "0x302126a4537c8189d8d94cc45e4127c8c7069dfa352de9195588a741870dfdcc",
        "status": 0,
        "speed": 0,
        "ships": {
            "id": "0xe61990569be23b7325ec8d418445c14f4173a7cfea1ac62b42a7439cba0b068f",
            "size": 0
        },
        "updatedCoordinates": {
            "x": 50,
            "y": 50
        },
        "coordinatesUpdatedAt": 0,
        "environmentOwned": false,
        "energyVault": 0,
        "version": 0,
        "offChainVersion": 0
    },
    {
        "rosterId": {
            "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
            "sequenceNumber": 4
        },
        "id_": "0xb490508e29aebda93bb90868f1bb9d455810785d8eda48b5c72e3b05012387a3",
        "status": 0,
        "speed": 4,
        "ships": {
            "id": "0x20a0743fe4a541e1ea9483035758273b1d3dc02627c675ea19bd5ba4a1df95de",
            "size": 4
        },
        "updatedCoordinates": {
            "x": 50,
            "y": 50
        },
        "coordinatesUpdatedAt": 0,
        "environmentOwned": false,
        "energyVault": 0,
        "version": 0,
        "offChainVersion": 0,
        "rosterShipsItems": [
            {
                "key": "0xe80a2fbcb21a9a2b318b30bf478fef5ef0c35e542460f0432d6470ee6c3e1eb6",
                "value": {
                    "owner": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "building_expenses": {
                        "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pairs::ItemIdQuantityPairs",
                        "fields": {
                            "items": [
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 102,
                                        "quantity": 4
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 200,
                                        "quantity": 5
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 301,
                                        "quantity": 6
                                    }
                                }
                            ]
                        }
                    },
                    "attack": 5,
                    "protection": 5,
                    "id": {
                        "id": "0xe80a2fbcb21a9a2b318b30bf478fef5ef0c35e542460f0432d6470ee6c3e1eb6"
                    },
                    "health_points": 20,
                    "version": "0",
                    "speed": 4
                },
                "offChainVersion": 0,
                "rosterId": {
                    "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "sequenceNumber": 4
                }
            },
            {
                "key": "0x273bd00b0df174f6595fcd5f6e8dbe8344a38a5f6aa4516e0002b49def8c39c4",
                "value": {
                    "owner": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "building_expenses": {
                        "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pairs::ItemIdQuantityPairs",
                        "fields": {
                            "items": [
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 102,
                                        "quantity": 6
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 200,
                                        "quantity": 5
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 301,
                                        "quantity": 4
                                    }
                                }
                            ]
                        }
                    },
                    "attack": 4,
                    "protection": 5,
                    "id": {
                        "id": "0x273bd00b0df174f6595fcd5f6e8dbe8344a38a5f6aa4516e0002b49def8c39c4"
                    },
                    "health_points": 20,
                    "version": "0",
                    "speed": 5
                },
                "offChainVersion": 0,
                "rosterId": {
                    "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "sequenceNumber": 4
                }
            },
            {
                "key": "0x80dc17e475a259cde1a114689d110f8aa109e0bcabcf85b4876371ebc813f744",
                "value": {
                    "owner": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "building_expenses": {
                        "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pairs::ItemIdQuantityPairs",
                        "fields": {
                            "items": [
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 102,
                                        "quantity": 6
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 200,
                                        "quantity": 4
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 301,
                                        "quantity": 5
                                    }
                                }
                            ]
                        }
                    },
                    "attack": 5,
                    "protection": 4,
                    "id": {
                        "id": "0x80dc17e475a259cde1a114689d110f8aa109e0bcabcf85b4876371ebc813f744"
                    },
                    "health_points": 20,
                    "version": "0",
                    "speed": 5
                },
                "offChainVersion": 0,
                "rosterId": {
                    "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "sequenceNumber": 4
                }
            },
            {
                "key": "0xdf17c004d47be86384895044a4df3325928a82706733e7a1562ab3ecd46957cf",
                "value": {
                    "owner": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "building_expenses": {
                        "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pairs::ItemIdQuantityPairs",
                        "fields": {
                            "items": [
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 102,
                                        "quantity": 5
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 200,
                                        "quantity": 6
                                    }
                                },
                                {
                                    "type": "0x9e1f56b7299081e61f81ba261fe333e98cb59a866dcf90e0c00df21180c96487::item_id_quantity_pair::ItemIdQuantityPair",
                                    "fields": {
                                        "item_id": 301,
                                        "quantity": 4
                                    }
                                }
                            ]
                        }
                    },
                    "attack": 4,
                    "protection": 5,
                    "id": {
                        "id": "0xdf17c004d47be86384895044a4df3325928a82706733e7a1562ab3ecd46957cf"
                    },
                    "health_points": 20,
                    "version": "0",
                    "speed": 5
                },
                "offChainVersion": 0,
                "rosterId": {
                    "playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
                    "sequenceNumber": 4
                }
            }
        ],
        "shipIds": [
            "0xe80a2fbcb21a9a2b318b30bf478fef5ef0c35e542460f0432d6470ee6c3e1eb6",
            "0x273bd00b0df174f6595fcd5f6e8dbe8344a38a5f6aa4516e0002b49def8c39c4",
            "0x80dc17e475a259cde1a114689d110f8aa109e0bcabcf85b4876371ebc813f744",
            "0xdf17c004d47be86384895044a4df3325928a82706733e7a1562ab3ecd46957cf"
        ]
    }
]
```

返回的数据为 JSON 数组，数组内的每个元素代表一个船队。
船队元素包含的属性：

* `rosterId` 为船队的业务主键 ID。
  其下的属性 `playerId ` 为船队所属玩家 ID，
  `sequenceNumber` 为该船队的编号。
* `id_` 为 Sui 的船队 Move 对象 ID（`{RosterObjectId}`）。
* `status` 为船队的状态。0：停泊中，1：行进中，2：战斗中，3：已损毁。
* `speed` 为船队的速度。
* `updatedCoordinates` 船队最后一次更新的位置坐标。
* `environmentOwned` 是否是“环境”船队。（用于 PvE。）
* `coordinatesUpdatedAt` 船队位置坐标的最后更新时间。
* `shipIds` 该船队包含的船只 ID 的列表。
* `rosterShipsItems` 该船队包含的船只对象信息的列表。

注意船队的 `rosterShipsItems` 属性，该属性为 JSON 数组。
其中的数组元素主要包含以下属性：

* `key` 为船只的对象 ID。
* `attack` 为该船只的攻击值。
* `protection` 为该船只的防御值。
* `speed` 为船只的速度。
* `health_points` 为该船只的健康值。
* `value` 包含了该船只的建造原料信息。
* `value.building_expenses.fields.items` 是该船只的建造原料列表。
* `value.building_expenses.fields.items.fields.item_id` 建造原料的 Item ID。
* `value.building_expenses.fields.items.fields.quantity` 建造原料的数量。

#### 通过 indexer 查询玩家的技能进程

使用 curl 命令可以取得指定玩家的船队信息：

```shell
curl -X GET "http://localhost:1023/api/SkillProcesses?skillProcessId.playerId=0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291" -H "accept: application/json"
```

输出信息类似下面这样：

```json
[{
	"skillProcessId": {
		"skillType": 0,
		"playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
		"sequenceNumber": 0
	},
	"id_": "0x3a2b5e7b36111f2fb9f6423c6c2ef5a5cba73f441af6fec0cb616ee37698356b",
	"itemId": 102,
	"startedAt": 1716278816,
	"creationTime": 5,
	"completed": true,
	"endedAt": 1716278829,
	"energyVault": 5,
	"batchSize": 1,
	"version": 2,
	"offChainVersion": 0
}, {
	"skillProcessId": {
		"skillType": 0,
		"playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
		"sequenceNumber": 1
	},
	"id_": "0xb70e54cfca7a3f6fa68bc616e761a47789f6013e51aa2d616f61e5e10982bbab",
	"itemId": 0,
	"startedAt": 0,
	"creationTime": 0,
	"completed": true,
	"endedAt": 0,
	"energyVault": 0,
	"batchSize": 1,
	"version": 0,
	"offChainVersion": 0
}, {
	"skillProcessId": {
		"skillType": 1,
		"playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
		"sequenceNumber": 0
	},
	"id_": "0x9ced723bd1cd3a36aa7b778c6596f1ebf0182fd3f65c9e4144bfe623f7c7909b",
	"itemId": 200,
	"startedAt": 1716278848,
	"creationTime": 3,
	"completed": true,
	"endedAt": 1716278861,
	"energyVault": 5,
	"batchSize": 1,
	"version": 2,
	"offChainVersion": 0
}, {
	"skillProcessId": {
		"skillType": 3,
		"playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
		"sequenceNumber": 0
	},
	"id_": "0xbd0d065237b2b11136c9d2f3d88cdc8909e1869a7ab44bf0398d373571701629",
	"itemId": 301,
	"startedAt": 1716278781,
	"creationTime": 3,
	"completed": true,
	"endedAt": 1716278798,
	"energyVault": 1,
	"batchSize": 1,
	"version": 2,
	"offChainVersion": 0
}, {
	"skillProcessId": {
		"skillType": 6,
		"playerId": "0xf07a26fe8ad373a65bca4c99aab65c2872b29156e0c6a677af01edf23058a291",
		"sequenceNumber": 0
	},
	"id_": "0xf9c94a70f9fe017e5f3e9cba022d3b82b48382f3b8581fe1e48b1256885bc6b3",
	"itemId": 1000000001,
	"startedAt": 1716279939,
	"creationTime": 3,
	"completed": true,
	"endedAt": 1716280103,
	"energyVault": 50,
	"productionMaterials": {
		"items": [{
			"itemId": 102,
			"quantity": 4
		}, {
			"itemId": 200,
			"quantity": 4
		}, {
			"itemId": 301,
			"quantity": 7
		}]
	},
	"batchSize": 1,
	"version": 10,
	"offChainVersion": 2
}]
```

返回的数据是一个 JSON 数组，数组中的每个元素都表示一个技能进程（“生产线”）。
元素包含的属性：

* `skillProcessId` 为技能进程的业务主键 ID。
  其中 `skillType` 表示技能类型，
  `playerId` 为玩家对象 ID，
  `sequenceNumber` 为该技能的“生产线”序列号。
  目前，除了农业（farming）有 0 和 1，其他技能这里都是 0。
* `itemId` 为该技能进程的产出成品的 Item ID。
* id_ 为 Sui 的技能进程 Move 对象 ID（{SkillProcessObjectId}）。
* `startedAt` 技能进程的最后一次启动时间。这是一个以秒数计算的 Unix 时间。
* `completed` 最后一次“生产”是否已完成。
  如果完成，可以开始下一次生产；
  如果没有完成，但是“时间已到”，那么前端可以调用相应的 complete 方法来获取制造结果，
  并更新“生产线”的状态。
* `endedAt` 最后一次“生产”的结束时间。
* `energyVault` 消耗能量币的数量。
* `batchSize` 本批次的数量，即按照“生产配方”投产的“份数”。
  “生产配方”定义的原材料和产出成品的数量都是“一份”的数量。
* `id_` 为 Sui 的船队 Move 对象 ID（`{RosterObjectId}`）。
* `id_` 为 Sui 的船队 Move 对象 ID（`{RosterObjectId}`）。

上述 `skil_type`，`sequence_number` 以及 `id_` 与前文中的技能进程占位符之间存在以下对应关系：


| skill_type | sequence_number | id_                      |
| ---------- | --------------- | ------------------------ |
| 0          | 0               | `{SkillProcessFarming1}` |
| 0          | 1               | `{SkillProcessFarming2}` |
| 1          | 0               | `{SkillProcessWooding}`  |
| 3          | 0               | `{SkillProcessMining}`   |
| 6          | 0               | `{SkillProcessCrafting}` |

### 开始挖矿流程

玩家进行挖矿流程时，需要执行“开始挖矿流程”命令：

执行如下 Sui CLI 开始挖矿：

```powershell
sui client call --package {main.PackageId} \
--module skill_process_service --function start_creation \
--args {SkillProcessMining} \
{batchSize} \
{playerId} \
{common.ItemCreationMining} \
{clock} \
{energyId} \
--gas-budget 11000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包的 ID。
* `{SkillProcessMining}`： 挖矿进程 Move 对象 ID，参考前文中的技能进程占位符。
* `batchSize`： 本批次的数量，即按照“生产配方”投产的“份数”。 “生产配方”定义的原材料和产出成品的数量都是“一份”的数量。
* `{playerId}`： 玩家对象 ID。
* {`common.ItemCreationMining}`： 挖矿配方对象 ID。
* `{clock}` ：开始挖矿进程时间，固定值：0x6。
* `{eneryId}` ：能量币（`ENERGY`）的 Object ID。

每一种生产制造进程都需要经历一定的时间，比如挖“一份”矿需要 3 秒钟，那么开始一次“挖矿”进程后，结合本次挖矿批次数量 ` batchSize`，则在经历  `batchSize` * 3 秒钟后，需要执行对应的“完成挖矿进程”来结束挖矿进程。

在技能进程成功开始后，会扣除玩家相应的原材料资源。

### 结束挖矿流程

开始挖矿进程并经过所需时间之后，需执行“结束挖矿进程”来完成挖矿。

执行如下 Sui CLI 来结束挖矿：

```powershell
sui client call --package {main.PackageId} \
--module skill_process_aggregate \
--function complete_creation \
--args {SkillProcessMiningId} \
{playerId} \
{common.itemCreationMining} \
{common.experienceTableId} \
{clock} \
 --gas-budget 42000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包的 ID。
* `{SkillProcessMining}`： 挖矿进程 Move 对象 ID，参考前文中的技能进程占位符。
* `{playerId}`： 玩家对象 ID。
* {`common.ItemCreationMining}`：挖矿配方对象 ID。
* `{common.experienceTableId}`： 玩家积分（经验）等级表格对象 ID。
* `{clock}`： 结束挖矿进程时间，固定值：0x6。

在成功结束技能进程之后，玩家的对应产出成果的资源数量会增加。

### 开始伐木进程

除将参数 `{SkillProcessMining}`  更改为 `{SkillProcessWooding}`，

将参数 `{common.ItemCreationMining}` 更改为 `{common.ItemCreationWooding}` 之外，

其余参数与上述“开始挖矿进程”相同，这里不再赘述。

### 结束伐木进程

除将参数 `{SkillProcessMining}`  更改为 `{SkillProcessWooding}`，

将参数 `{common.ItemCreationMining}` 更改为 `{common.ItemCreationWooding}` 之外，

其余参数与上述“结束挖矿进程”相同，这里不再赘述。

### 开始种植棉花进程

种植棉花进程有两条“生产线”，对应的技能进程对象 ID 分别为 `{SkillProcessFarming1}` 和 `{SkillProcessFarming2}`。

对于种植棉花这项技能来说，玩家可以同时开启两条“生产线”。

我们以开启种植棉花的第一条“生产线”举例，执行以下 Sui CLI 命令：

```powershell
sui client call --package {main.PackageId} \
--module skill_process_service \
--function start_production 
--args {SkillProcessFarming1} \
{batchSize} \
{playerId} \
{common.ItemProductionFarming} \
{clock} 
{energyId} \
--gas-budget 11000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包的 ID。
* `{SkillProcessFarming1}`： 种植棉花第一条“生产线”的 Move 对象 ID、

  `{SkillProcessFarming2}`： 为第二条“生产线”的 Move 对象 ID。
* `batchSize` 本批次的数量，即按照“生产配方”投产的“份数”。“生产配方”定义的原材料和产出成品的数量都是“一份”的数量。
* `{playerId}`： 玩家对象 ID。
* {`common.ItemProductionFarming}`： 种植棉花配方 Move 对象 ID。
* `{clock}：` 开始种植棉花进程时间，固定值：0x6。
* `{eneryId}：` 能量币（`ENERGY`）的 Object ID。

### 结束种植棉花进程

玩家要结束“种植棉花”进程，需要执行以下 Sui CLI 命令：

```powershell
sui client call --package {main.PackageId} \
 --module skill_process_aggregate \
--function complete_production \
--args {SkillProcessFarming1} \
{playerId} \
{common.ItemProductionFarming} \
{common.ExperienceTable} \
{clock} \
--gas-budget 42000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包的 ID。
* `{SkillProcessFarming1}`： 种植棉花第一条“生产线”的 Move 对象 ID、

  另： `{SkillProcessFarming2}` 为第二条“生产线”的 Move 对象 ID。
* `{playerId}`： 玩家对象 ID。
* {`common.ItemProductionFarming}`： 种植棉花配方 Move 对象 ID。
* `{clock}`： 结束种植棉花进程时间，固定值：0x6。
* `{common.ExperienceTable}：` 玩家积分（经验）等级表格对象 ID。

结束种植棉花过程应该在达到所需时间基础上进行。

### 开始造船进程

玩家在占领岛屿后，可以造船并管理自己的船队。

如果想要造船，可以执行以下 Sui CLI 命令开启造船流程：

```powershell
sui client call --package {main.PackageId} \
--module skill_process_service \
--function start_ship_production \
--args  {SkillProcessCrafting} \
{production_materials_item_id_list} \
{production_materials_item_quantity_list} \
{playerId} \
{common.ItemProductionCrafting} \
{$clock} \  
{EnergyId} \
--gas-budget 42000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包的 ID。
* {`production_materials_item_id_list}`： 造船所需的资源的 Item ID 的数组。通常为：[2000000001,2000000003,102]。
* `{production_materials_item_quantity_list}`：造船所需资源数量的数组，与 `production_materials_item_id_list` 中的 Item ID 一一对应。如：[180,230,190]，每种资源数量最少 150，总数量为 600。具体每种资源数量由玩家指定。
* `{SkillProcessCrafting}`：造船技能的 Move 对象 ID。
* `{playerId}`：玩家对象 ID。
* {`common.ItemProductionCrafting}`： 造船配方 Move 对象 ID。
* `{clock}`： 开始造船流程时间，固定值：0x6。
* `{eneryId}`： 能量币（`ENERGY`）的 Object ID。

### 结束造船进程

经过所需的造船时间之后，需要调用下面的 Sui CLI 命令来结束造船进程。

```powershell
sui client call --package (main.PackageId) \
--module skill_process_aggregate \
--function complete_ship_production \
--args  {SkillProcessCrafting} \n
{rosterId} \
{playerId}  \
{ItemProductionCrafting} \
{common.ExperienceTable} \
{clock}  \
--gas-budget 42000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包的 ID。
* `{SkillProcessCrafting}`： 玩家造船技能的 Move 对象 ID。
* {`rosterId}`：序号为 0 的船队 Move 对象 ID，即前文中提到的有特殊含义容纳“Unassigned Ships”的船队 。
* `{playerId}`： 玩家对象 ID。
* {`common.ItemProductionCrafting}`： 造船配方 Move 对象 ID。
* `{clock}`： 结束造船进程时间，固定值：0x6。
* `{common.ExperienceTable}`： 玩家积分（经验）等级表格对象 ID。

### 船队添加船只

每个玩家有 5 支船队，编号为 0-4 ，其中编号为 0 的船队为 "unassigned roster"，玩家新建的船只先加入该船队。编号 1-4 的船队，每支船队可以容纳 4 艘船，给这些船队中添加船只时，可以执行以下 Sui CLI 命令：

```powershell
sui client call --package {main.PackageId} \
 --module roster_aggregate \
--function transfer_ship \
--args  {sourceRoster} \
{playerId} \
{shipId}  \
{targetRoster} \
{targetPosition} \
 --gas-budget 42000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包的 ID。
* `{sourceRoster}`：编号为 0 的船队 Move 对象 ID。
* `{playerId}`： 玩家对象 ID。
* `{shipId}`：被添加船只的对象 ID。
* {`targetRoster}`： 目标船队对象 ID，必须是编号 1-4 的船队 ID 之一。
* `{targetPosition}`： 将船只添加到目标船队的位置，格式 [{No}]，No 的取值范围为 0-3 或者空。如果为空，也就是 [] 将船只添加到船队末尾位置。

### 取消船只

可以将编号 1-4 的船队中的指定船只取消，被取消的船只自动回到编号为 0 的“unassigned roster”船队。

可以通过以下 Sui CLI 命令执行取消命令：

```powershell
sui client call --package {main.PackageId} \
 --module roster_aggregate \
--function transfer_ship \
--args  {sourceRoster} \
{playerId} \
{shipId}  \
{targetRoster} \
{targetPosition} \
 --gas-budget 42000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包的 ID。
* {`sourceRoster}`：编号为 1-4 的玩家船队的 Move 对象 ID。
* `{playerId}`： 玩家对象 ID。
* `{shipId}`：被取消船只的对象 ID。
* {`targetRoster}`： 编号为 0 的玩家船队的 Move 对象 ID。
* `{targetPosition}`： 取值 [] 表示取消的的船只置于“unassigned roster”船队的末尾。

可以发现船队“添加船只”和“取消船只”是同一个接口。

### 调整船只顺序

玩家可以调整船队中现有船只的顺序。

通过执行以下 Sui CLI 命令确定船队内所有船只的最终顺序：

```powershell
sui client call --package {main.PackageId} \
--module roster_aggregate \
--function adjust_ships_position \
--args {rosteId} \
{playerId} \
{positions} \
{shipIds}  \
--gas-budget 4999000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包的 ID。
* `{rosteId}`：调整船只顺序的船队的 ID。
* `{playerId}`： 玩家对象 ID。
* `{shipIds}`： 变更顺序的船只的 ID 的数组。
* {`positions}`： 与 `shipIds` 数组中船只对应的最新位置数组。

### 船队航行

通过以下的 Sui CLI 命令将指定船队移动到指定位置。

```powershell
sui client call --package (main.PackageId) \
--module roster_service \
--function set_sail \
--args {roster} \
{playerId} \
{target_coordinates_x} \
{target_coordinates_y} \
{clock} \
{energyId} \
{energy_amount} \
--gas-budget 11000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包 ID。
* `{roste}`：船队对象 ID。
* `{playerId}`： 玩家对象 ID。
* `{target_coordinates_x}`：航行目的地的横坐标。
* {`target_coordinates_y}`： 航行目的地的纵坐标。
* {`clock}`： 航行开始时间，固定值 `0x6`。
* {`energyId}`：能量币（`ENERGY`）的 Object ID。
* {`energy_amount}`： 本次航行需要花费能量币（`ENERGY`）数量。

### 资源转移

目前有三种资源转移方式：同船队船与船之间、将船上的资源转移到岛屿、将岛屿的资源转移到船上。

#### 船与船之间资源转移

只有同一船队之间的船只之间才可以进行资源的转移，可以通过以下的 Sui CLI 命令实现：

```powershell
sui client call --package {main.packageId} \
--module roster_aggregate \
--function transfer_ship_inventory \
--args {roster} \
{playerId} \
{fromShipId} \
{toShipId} \
{itemIds} \
{quantities} \
 --gas-budget 11000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包 ID。
* `{roste}`：船队对象 ID。
* `{playerId}`： 玩家对象 ID。
* `{fromShipId}`：转移资源船只对象 ID。
* {`toShipId}`： 接收资源船只对象 ID。
* {`itemIds}`： 转移资源（Item) 的 ID 的数组。
  如：`[2,200,301]`，表示要转移 Item ID 为 2、200、301 的三种资源。
* {`quantities}`：转移资源（Item）的数量数组。
  如：`[38,11,23]`，结合上面的 `itemIds`，用以表示以上三种资源各自转移数量。

注意：对象 ID 为 `{fromShipId}` 和 `{toShipId}` 的船只均属于对象 ID 为 `{roste}` 的同一船队。


#### 船只资源转移到岛屿

停泊在玩家自己岛屿附近的玩家船只上的资源可以转移到岛屿，通过以下的 Sui CLI 命令实现：

```powershell
sui client call --package {main.packageId} \
--module roster_aggregate \
--function take_out_ship_inventory \
--args {roster} \
{playerId} \
{clock} \
{shipId} \
{itemIds} \
{quantities} \
 --gas-budget 11000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包 ID。
* `{roste}`：船队对象 ID。
* `{playerId}`： 玩家对象 ID。
* `{shipId}`：转移资源船只对象 ID。
* `{clock}`转移时间，固定值`0x6`。
* {`itemIds}`： 转移资源（Item) 的 ID 的数组。
  如：`[2,200,301]`，表示要转移 Item ID 为 2、200、301 的三种资源。
* {`quantities}`：转移资源（Item）的数量数组。
  如：`[38,11,23]`，结合上面的 `itemIds`，用以表示以上三种资源各自转移数量。

#### 岛屿资源转移到船只

同样可以将玩家自己岛屿上的资源转移到停泊在附近的玩家船只上，通过以下的 Sui CLI 命令实现：

```powershell
sui client call --package {main.packageId} \
--module roster_aggregate \
--function put_in_ship_inventory \
--args {roster} \
{playerId} \
{clock} \
{shipId} \
{itemIds} \
{quantities} \
 --gas-budget 11000000 --json
```

参数解释：

* `{main.PackageId}`：Main 合约包 ID。
* `{roste}`：船队对象 ID。
* `{playerId}`： 玩家对象 ID。
* `{clock}` 转移时间，固定值 `0x6`。
* `{shipId}`：转移资源船只对象 ID。
* {`itemIds}`： 转移资源（Item) 的 ID 的数组。
  如：`[2,200,301]`，表示要转移 Item ID 为 2、200、301 的三种资源。
* {`quantities}`：转移资源（Item）的数量数组。
  如：`[38,11,23]`，结合上面的 `itemIds`，用以表示以上三种资源各自转移数量。


[TBD]

### 关于 Move Table 或者 ObjectTable 内容的查询

使用 `sui client object {OBJECT_ID}` 命令查询一个对象，如果对象包含类型为 `Table` 或者 `ObjectTable` 类型的字段，
那么这个字段的信息输出类似下面这样：

```text
"items": {
        "type": "0x2::table::Table<{KEY_TYPE}, {VALUE_TYPE}>",
        "fields": {
          "id": {
            "id": "0x600ff5d855b5d9ff63edd9d9215457e1c1f6cbb316dc95999ac0d180c886e197"
          },
          "size": "2"
        }
      },
```

在上面的示例输出中，“表”（table）的 ID 是 `0x600ff5d855b5d9ff63edd9d9215457e1c1f6cbb316dc95999ac0d180c886e197`。
然后我们可以这样获取 table 的“动态字段”（你可以把动态字段理解为表的“行”）——这是个“分页”查询接口：

```shell
curl -X POST \
-H "Content-Type: application/json" \
-d '{"jsonrpc":"2.0","id":1,"method":"suix_getDynamicFields","params":["0x600ff5d855b5d9ff63edd9d9215457e1c1f6cbb316dc95999ac0d180c886e197"]}' \
https://fullnode.testnet.sui.io/
```

如果获取的是 `Table` 类型的“表”，那么，返回的分页内容类似下面这样：

```text
{"jsonrpc":"2.0","result":{"data":[
{"name":{"type":"u32","value":1},"bcsName":"2UzHM","type":"DynamicField","objectType":"0x14ba8a9763d9883be8dcedce946efc25e5cbc80c4b8f09d1dbc89731fa517fb8::player_item::PlayerItem",
"objectId":"0x8655ebf801c0d9f734bc09b9b6aaff781f4d18c66e8ea4e0cb6261315f7b5bee","version":26421773,"digest":"4dCkgDHtD9cbQAz7P9Lveetm7PfSC8DbABfySHYmgTgy"},
{"name":{"type":"u32","value":2},"bcsName":"3xyZh","type":"DynamicField","objectType":"0x14ba8a9763d9883be8dcedce946efc25e5cbc80c4b8f09d1dbc89731fa517fb8::player_item::PlayerItem",
"objectId":"0x970ccbbd1b5670c4f1e13c8a8eafddf53c0a579b158129e961046ee6c321c739","version":26421895,"digest":"4BnmTVdyAgVT8qN7um8h1CXdWpHqjYPQsyMTmYWKaCjr"}
],"nextCursor":"0x970ccbbd1b5670c4f1e13c8a8eafddf53c0a579b158129e961046ee6c321c739","hasNextPage":false},"id":1}
```

返回的分页列表中的元素，`"type":"DynamicField"`，你可以这些元素理解为“动态字段”的“引用”，而不是动态字段的内容的全部。
然后，再像下面这样，通过动态字段的 ID，获取“动态字段”的内容（动态字段也是一个“对象”）：

```shell
sui client object 0x8655ebf801c0d9f734bc09b9b6aaff781f4d18c66e8ea4e0cb6261315f7b5bee

sui client object 0x970ccbbd1b5670c4f1e13c8a8eafddf53c0a579b158129e961046ee6c321c739
```

---

如果获取的是 `ObjectTable` 类型的表，
那么，`suix_getDynamicFields` 方法返回分页列表中的元素，`"type":"DynamicObject"`。

### Test off-chain service

#### Configuring off-chain service

Open the `application-test.yml` file located in the directory `sui-java-service/suiinfinitesea-service-rest/src/main/resources` and set the publishing transaction digests.

After setting, it should look like this:

```yaml
sui:
  contract:
    jsonrpc:
      url: "https://fullnode.testnet.sui.io/"
    package-publish-transactions:
      common: "{COMMON_PACKAGE_PUBLISH_TRANSACTION_DIGEST}"
      default: "{DEFAULT_PACKAGE_PUBLISH_TRANSACTION_DIGEST}"
```

This is the only place where off-chain service need to be configured, and it's that simple.

#### Creating a database for off-chain service

Use a MySQL client to connect to the local MySQL server and execute the following script to create an empty database (assuming the name is `test5`):

```sql
CREATE SCHEMA `test7` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_bin;
```

Go to the `sui-java-service` directory and package the Java project:

```shell
mvn package
```

Then, run a command-line tool to initialize the database:

```shell
java -jar ./suiinfinitesea-service-cli/target/suiinfinitesea-service-cli-0.0.1-SNAPSHOT.jar ddl -d "./scripts" -c "jdbc:mysql://127.0.0.1:3306/test7?enabledTLSProtocols=TLSv1.2&characterEncoding=utf8&serverTimezone=GMT%2b0&useLegacyDatetimeCode=false" -u root -p 123456
```

#### Starting off-chain service

In the `sui-java-service` directory, execute the following command to start the off-chain service:

```shell
mvn -pl suiinfinitesea-service-rest -am spring-boot:run
```
